<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carnet d'adresses</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 2rem;
    }

    h1 {
      text-align: center;
    }

    .form-section, .filter-section {
      margin-bottom: 2rem;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
    }

    input, select, button {
      margin: 0.5rem 0;
      padding: 0.5rem;
      width: 100%;
    }

    .filters {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filters select {
      flex: 1;
      min-width: 150px;
    }

    .contact-card {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: #f9f9f9;
    }

    .contact-actions {
      position: absolute;
      top: 8px;
      right: 8px;
    }

    .contact-actions button {
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>üìí Carnet d'adresses</h1>

  <!-- Ajouter un contact -->
  <div class="form-section">
    <h2>‚ûï Ajouter un contact</h2>
    <input id="prenom" placeholder="Pr√©nom">
    <input id="nom" placeholder="Nom">
    <input id="email" placeholder="Email">
    <select id="groupe" onchange="majSousGroupesFormulaire()">
      <option value="">Choisir un groupe</option>
      <option>Equipe p√©dagogique</option>
      <option>BUT1</option>
      <option>BUT2</option>
      <option>BUT3</option>
    </select>
    <select id="sous-groupe">
      <option value="">Choisir un sous-groupe</option>
    </select>
    <button onclick="ajouterContact()">Ajouter</button>
  </div>

  <!-- Filtres -->
  <div class="filter-section">
    <h2>üìã Liste des contacts</h2>
    <div class="filters">
      <select id="filtre-groupe" onchange="majSousGroupesFiltres(); chargerContactsFiltr√©s();">
        <option value=""><all> Groupe</option>
        <option>Equipe p√©dagogique</option>
        <option>BUT1</option>
        <option>BUT2</option>
        <option>BUT3</option>
      </select>

      <select id="filtre-sous-groupe" onchange="chargerContactsFiltr√©s()">
        <option value=""><all> Sous-groupe</option>
      </select>
    </div>
  </div>

  <!-- Liste des contacts -->
  <div id="liste-contacts"></div>

  <script>
    const API_URL = "https://carnet-api.onrender.com/api/contacts";

    const sousGroupesComplet = {
      "Equipe p√©dagogique": ["Enseignants", "Intervenants", "BIATSS"],
      "BUT1": ["TD1", "TD2", "TP1", "TP2", "TP3", "TP4"],
      "BUT2": ["TD1", "TD2", "TP1", "TP2", "TP3", "TP4"],
      "BUT3": ["TD1", "TD2", "TP1", "TP2", "TP3", "TP4"]
    };

    const sousGroupesFormulaire = {
      "Equipe p√©dagogique": ["Enseignants", "Intervenants", "BIATSS"],
      "BUT1": ["TP1", "TP2", "TP3", "TP4"],
      "BUT2": ["TP1", "TP2", "TP3", "TP4"],
      "BUT3": ["TP1", "TP2", "TP3", "TP4"]
    };

    // INIT
    window.onload = () => {
      majSousGroupesFiltres();
      chargerContactsFiltr√©s();
    };

    function majSousGroupesFormulaire() {
      const groupe = document.getElementById("groupe").value;
      const sous = document.getElementById("sous-groupe");
      sous.innerHTML = `<option value="">Choisir un sous-groupe</option>`;

      if (sousGroupesFormulaire[groupe]) {
        sousGroupesFormulaire[groupe].forEach(sg => {
          const opt = document.createElement("option");
          opt.value = sg;
          opt.textContent = sg;
          sous.appendChild(opt);
        });
      }
    }

    function majSousGroupesFiltres() {
      const groupe = document.getElementById("filtre-groupe").value;
      const sous = document.getElementById("filtre-sous-groupe");
      sous.innerHTML = `<option value=""><all> Sous-groupe</option>`;

      if (sousGroupesComplet[groupe]) {
        sousGroupesComplet[groupe].forEach(sg => {
          const opt = document.createElement("option");
          opt.value = sg;
          opt.textContent = sg;
          sous.appendChild(opt);
        });
      }
    }

    async function ajouterContact() {
      const contact = {
        prenom: document.getElementById("prenom").value,
        nom: document.getElementById("nom").value,
        email: document.getElementById("email").value,
        groupe: document.getElementById("groupe").value,
        sous_groupe: document.getElementById("sous-groupe").value
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(contact)
        });

        if (res.ok) {
          alert("‚úÖ Contact ajout√© !");
          chargerContactsFiltr√©s();
        } else {
          alert("‚ùå Erreur ajout : " + await res.text());
        }
      } catch (err) {
        alert("‚ùå Erreur r√©seau : " + err.message);
      }
    }

    async function chargerContactsFiltr√©s() {
      try {
        const res = await fetch(API_URL);
        const contacts = await res.json();

        const filtreG = document.getElementById("filtre-groupe").value;
        const filtreSG = document.getElementById("filtre-sous-groupe").value;

        const filtr√©s = contacts.filter(c =>
          (!filtreG || c.groupe === filtreG) &&
          (!filtreSG || c.sous_groupe === filtreSG)
        );

        afficherContacts(filtr√©s);
      } catch (err) {
        alert("‚ùå Chargement √©chou√© : " + err.message);
      }
    }

    function afficherContacts(contacts) {
      const div = document.getElementById("liste-contacts");
      div.innerHTML = "";

      if (contacts.length === 0) {
        div.textContent = "Aucun contact trouv√©.";
        return;
      }

      contacts.forEach(c => {
        const card = document.createElement("div");
        card.className = "contact-card";
        card.innerHTML = `
          <div class="contact-actions">
            <button onclick="modifierContact(${c.id})">‚úèÔ∏è</button>
            <button onclick="supprimerContact(${c.id})">üóëÔ∏è</button>
          </div>
          <strong>${c.prenom} ${c.nom}</strong><br>
          Email : ${c.email}<br>
          Groupe : ${c.groupe || '-'}<br>
          Sous-groupe : ${c.sous_groupe || '-'}
        `;
        div.appendChild(card);
      });
    }

    async function supprimerContact(id) {
      if (!confirm("üóëÔ∏è Supprimer ce contact ?")) return;

      try {
        const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        if (res.ok) {
          chargerContactsFiltr√©s();
        } else {
          alert("‚ùå √âchec suppression");
        }
      } catch (err) {
        alert("‚ùå Erreur r√©seau : " + err.message);
      }
    }

    function modifierContact(id) {
      alert("üîß Fonction de modification √† venir !");
    }
  </script>
</body>
</html>
